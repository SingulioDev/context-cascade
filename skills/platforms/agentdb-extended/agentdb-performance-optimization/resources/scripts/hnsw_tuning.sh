#!/bin/bash
# AgentDB HNSW Index Tuning Script
# Optimizes HNSW parameters for 150x-12,500x search performance

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
DB_PATH="${1:-.agentdb/vectors.db}"
DATASET_SIZE="${2:-medium}"

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}AgentDB HNSW Index Tuning${NC}"
echo -e "${BLUE}========================================${NC}\n"

# Validate database exists
if [ ! -f "$DB_PATH" ]; then
    echo -e "${RED}‚ùå Error: Database not found: $DB_PATH${NC}"
    echo "Usage: ./hnsw_tuning.sh <db_path> <dataset_size>"
    echo "Dataset sizes: small (<10K), medium (10K-100K), large (100K-1M), massive (>1M)"
    exit 1
fi

echo -e "${GREEN}Database: $DB_PATH${NC}"
echo -e "${GREEN}Dataset Size: $dataset_size${NC}\n"

# Determine optimal HNSW parameters based on dataset size
case "$DATASET_SIZE" in
    small)
        M=8
        EF_CONSTRUCTION=100
        EF_SEARCH=50
        DESCRIPTION="Small dataset (<10K vectors) - Fast build, minimal memory"
        ;;
    medium)
        M=16
        EF_CONSTRUCTION=200
        EF_SEARCH=100
        DESCRIPTION="Medium dataset (10K-100K) - Balanced performance"
        ;;
    large)
        M=32
        EF_CONSTRUCTION=400
        EF_SEARCH=200
        DESCRIPTION="Large dataset (100K-1M) - High quality index"
        ;;
    massive)
        M=48
        EF_CONSTRUCTION=500
        EF_SEARCH=250
        DESCRIPTION="Massive dataset (>1M vectors) - Maximum performance"
        ;;
    *)
        echo -e "${RED}‚ùå Error: Invalid dataset size: $DATASET_SIZE${NC}"
        echo "Valid sizes: small, medium, large, massive"
        exit 1
        ;;
esac

echo -e "${YELLOW}üìä HNSW Parameters for $DATASET_SIZE:${NC}"
echo -e "  M (connections per layer): ${GREEN}$M${NC}"
echo -e "  efConstruction (build quality): ${GREEN}$EF_CONSTRUCTION${NC}"
echo -e "  efSearch (search quality): ${GREEN}$EF_SEARCH${NC}"
echo -e "  Description: $DESCRIPTION\n"

# Expected performance metrics
case "$DATASET_SIZE" in
    small)
        EXPECTED_SEARCH="<100¬µs"
        EXPECTED_RECALL="95-98%"
        EXPECTED_BUILD="<1 second"
        ;;
    medium)
        EXPECTED_SEARCH="<200¬µs"
        EXPECTED_RECALL="97-99%"
        EXPECTED_BUILD="5-30 seconds"
        ;;
    large)
        EXPECTED_SEARCH="<500¬µs"
        EXPECTED_RECALL="98-99.5%"
        EXPECTED_BUILD="1-5 minutes"
        ;;
    massive)
        EXPECTED_SEARCH="<2ms"
        EXPECTED_RECALL="99%+"
        EXPECTED_BUILD="10-30 minutes"
        ;;
esac

echo -e "${YELLOW}‚ö° Expected Performance:${NC}"
echo -e "  Search Latency: ${GREEN}$EXPECTED_SEARCH${NC}"
echo -e "  Recall Rate: ${GREEN}$EXPECTED_RECALL${NC}"
echo -e "  Build Time: ${GREEN}$EXPECTED_BUILD${NC}\n"

# Generate TypeScript configuration
CONFIG_FILE=".agentdb/hnsw-config-${DATASET_SIZE}.ts"

cat > "$CONFIG_FILE" << EOF
/**
 * AgentDB HNSW Configuration for $DATASET_SIZE datasets
 * Auto-generated by hnsw_tuning.sh
 *
 * Expected Performance:
 * - Search Latency: $EXPECTED_SEARCH
 * - Recall Rate: $EXPECTED_RECALL
 * - Build Time: $EXPECTED_BUILD
 */

import { createAgentDBAdapter } from 'agentic-flow/reasoningbank';

export const hnswConfig = {
  dbPath: '$DB_PATH',

  // HNSW Index Parameters
  hnswM: $M,                    // Connections per layer
  hnswEfConstruction: $EF_CONSTRUCTION,  // Build quality (higher = better quality, slower build)
  hnswEfSearch: $EF_SEARCH,              // Search quality (higher = better recall, slower search)

  // Recommended additional settings for $DATASET_SIZE datasets
  cacheSize: $([ "$DATASET_SIZE" = "small" ] && echo "500" || [ "$DATASET_SIZE" = "medium" ] && echo "1000" || [ "$DATASET_SIZE" = "large" ] && echo "2000" || echo "5000"),
  quantizationType: '$([ "$DATASET_SIZE" = "small" ] && echo "none" || [ "$DATASET_SIZE" = "medium" ] && echo "scalar" || echo "binary")',

  enableLearning: true,
  enableReasoning: true,
};

// Initialize adapter with optimized settings
export async function createOptimizedAdapter() {
  const adapter = await createAgentDBAdapter(hnswConfig);

  console.log('AgentDB initialized with HNSW tuning for $DATASET_SIZE datasets');
  console.log('Expected search latency: $EXPECTED_SEARCH');
  console.log('Expected recall rate: $EXPECTED_RECALL');

  return adapter;
}

// Example usage:
// import { createOptimizedAdapter } from './$CONFIG_FILE';
// const adapter = await createOptimizedAdapter();
// const results = await adapter.retrieveWithReasoning(queryEmbedding, { k: 10 });
EOF

echo -e "${GREEN}‚úÖ Configuration file generated: $CONFIG_FILE${NC}\n"

# Generate benchmark script
BENCHMARK_FILE=".agentdb/benchmark-${DATASET_SIZE}.ts"

cat > "$BENCHMARK_FILE" << EOF
/**
 * AgentDB HNSW Benchmark for $DATASET_SIZE datasets
 * Tests search performance with current configuration
 */

import { createOptimizedAdapter } from './hnsw-config-${DATASET_SIZE}';

async function benchmark() {
  console.log('Starting HNSW benchmark for $DATASET_SIZE dataset...\n');

  const adapter = await createOptimizedAdapter();

  // Generate random query embedding (768 dimensions)
  const queryEmbedding = new Float32Array(768);
  for (let i = 0; i < 768; i++) {
    queryEmbedding[i] = Math.random() * 2 - 1;
  }

  // Warm-up query
  await adapter.retrieveWithReasoning(queryEmbedding, { k: 10 });

  // Benchmark search performance
  const iterations = 100;
  const startTime = performance.now();

  for (let i = 0; i < iterations; i++) {
    await adapter.retrieveWithReasoning(queryEmbedding, { k: 10 });
  }

  const endTime = performance.now();
  const avgLatency = (endTime - startTime) / iterations;

  console.log(\`Average Search Latency: \${avgLatency.toFixed(2)}ms\`);
  console.log(\`Expected: $EXPECTED_SEARCH\`);

  if (avgLatency < 1) {
    console.log('‚úÖ Performance: EXCELLENT (sub-millisecond)');
  } else if (avgLatency < 5) {
    console.log('‚úÖ Performance: GOOD');
  } else {
    console.log('‚ö†Ô∏è  Performance: Consider tuning parameters');
  }

  // Get database statistics
  const stats = await adapter.getStats();
  console.log(\`\nDatabase Statistics:\`);
  console.log(\`  Total Patterns: \${stats.totalPatterns?.toLocaleString()}\`);
  console.log(\`  Database Size: \${(stats.dbSize / (1024 * 1024)).toFixed(2)} MB\`);
  console.log(\`  Avg Confidence: \${stats.avgConfidence?.toFixed(2)}\`);
}

benchmark().catch(console.error);
EOF

echo -e "${GREEN}‚úÖ Benchmark script generated: $BENCHMARK_FILE${NC}\n"

# Generate comparison table
echo -e "${YELLOW}üìä HNSW Parameter Comparison Table:${NC}\n"
echo "| Dataset Size | M  | efConstruction | efSearch | Search Latency | Recall | Memory Usage |"
echo "|--------------|----|--------------------|----------|----------------|--------|--------------|"
echo "| Small (<10K) | 8  | 100                | 50       | <100¬µs         | 95-98% | Low          |"
echo "| Medium       | 16 | 200                | 100      | <200¬µs         | 97-99% | Medium       |"
echo "| Large        | 32 | 400                | 200      | <500¬µs         | 98-99% | High         |"
echo "| Massive (>1M)| 48 | 500                | 250      | <2ms           | 99%+   | Very High    |"

echo -e "\n${BLUE}========================================${NC}"
echo -e "${BLUE}Next Steps:${NC}"
echo -e "${BLUE}========================================${NC}"
echo -e "1. Import the configuration:"
echo -e "   ${GREEN}import { createOptimizedAdapter } from './$CONFIG_FILE';${NC}"
echo -e "\n2. Run the benchmark:"
echo -e "   ${GREEN}npx tsx $BENCHMARK_FILE${NC}"
echo -e "\n3. Adjust parameters if needed in $CONFIG_FILE"
echo -e "\n4. Monitor performance with:"
echo -e "   ${GREEN}npx agentdb@latest stats $DB_PATH${NC}\n"

# Parameter tuning tips
echo -e "${YELLOW}üí° Tuning Tips:${NC}"
echo -e "  ‚Ä¢ Increase M for better recall (but more memory)"
echo -e "  ‚Ä¢ Increase efConstruction for better index quality (but slower build)"
echo -e "  ‚Ä¢ Increase efSearch for better recall (but slower search)"
echo -e "  ‚Ä¢ Use binary quantization with large datasets to save memory"
echo -e "  ‚Ä¢ Cache hot patterns to reduce database queries\n"

echo -e "${GREEN}‚úÖ HNSW tuning complete!${NC}\n"
