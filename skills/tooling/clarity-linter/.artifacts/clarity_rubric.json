{
  "rubric_id": "clarity_rubric_v1",
  "version": "0.1.0",
  "description": "Rubric for evaluating code clarity and cognitive load, based on minimizing unnecessary indirection, thin helpers, mega-functions, and harmful duplication.",
  "entity_types": [
    "project",
    "file",
    "function"
  ],

  "metrics_spec": {
    "function": [
      {
        "id": "func_lines",
        "description": "Number of non-comment, non-blank lines in the function body.",
        "type": "integer"
      },
      {
        "id": "nesting_depth",
        "description": "Maximum nesting depth of control structures (if/else/loops/try) in the function.",
        "type": "integer"
      },
      {
        "id": "is_trivial_expression",
        "description": "True if the body consists of a single simple expression or statement.",
        "type": "boolean"
      },
      {
        "id": "is_single_call_forwarder",
        "description": "True if the function body is a single call that forwards parameters verbatim.",
        "type": "boolean"
      },
      {
        "id": "call_count",
        "description": "How many other functions call this function.",
        "type": "integer"
      },
      {
        "id": "name_semantic_score",
        "description": "0-1 heuristic score of how much domain meaning the function name encodes (e.g., 1.0 for 'is_valid_email', 0.1 for 'do_thing').",
        "type": "float"
      },
      {
        "id": "comment_density",
        "description": "Comment lines / total lines inside the function.",
        "type": "float"
      },
      {
        "id": "local_domain_spread",
        "description": "Heuristic 0-1 measure of how many unrelated concerns/domains this function touches.",
        "type": "float"
      }
    ],
    "file": [
      {
        "id": "thin_helper_count",
        "description": "Number of thin helper functions in this file.",
        "type": "integer"
      },
      {
        "id": "avg_func_length",
        "description": "Average function length (non-comment, non-blank lines).",
        "type": "float"
      },
      {
        "id": "avg_nesting_depth",
        "description": "Average nesting depth across functions in the file.",
        "type": "float"
      },
      {
        "id": "max_call_chain_depth",
        "description": "Estimated maximum call depth from any public entrypoint in this file.",
        "type": "integer"
      }
    ],
    "project": [
      {
        "id": "max_project_call_chain_depth",
        "description": "Max call chain depth across the whole project from known entrypoints.",
        "type": "integer"
      },
      {
        "id": "duplicate_block_count",
        "description": "Total number of duplicated code blocks above the configured size threshold.",
        "type": "integer"
      },
      {
        "id": "duplicate_block_details",
        "description": "Structured list of duplicated blocks (location, size, occurrences).",
        "type": "list"
      }
    ]
  },

  "thresholds": {
    "function": {
      "max_function_length_hard": 50,
      "max_function_length_soft": 40,
      "min_helper_length": 3,
      "max_comment_density": 0.35,
      "min_comment_density_for_complex": 0.05,
      "max_local_domain_spread": 0.6
    },
    "file": {
      "max_call_chain_depth": 4
    },
    "project": {
      "max_project_call_chain_depth": 6,
      "min_duplicate_block_lines": 5,
      "min_duplicate_occurrences_for_harm": 3
    },
    "semantic": {
      "meaningful_name_threshold": 0.6
    }
  },

  "dimensions": [
    {
      "id": "thin_helpers_and_indirection",
      "name": "Thin Helpers & Useless Indirection",
      "weight": 0.25,
      "applies_to": ["function", "file", "project"],
      "checks": [
        {
          "id": "THIN_HELPER_SIZE",
          "entity_type": "function",
          "severity": "warning",
          "description": "Function is so small and trivial that it likely does not justify its own helper.",
          "condition": {
            "all": [
              { "metric": "func_lines", "op": "<=", "value_from": "thresholds.function.min_helper_length" },
              { "metric": "is_trivial_expression", "op": "==", "value": true },
              { "metric": "name_semantic_score", "op": "<", "value_from": "thresholds.semantic.meaningful_name_threshold" }
            ]
          },
          "score_impact": -0.2,
          "message": "Function is a thin helper with trivial body and low semantic name value; prefer inlining this logic.",
          "suggested_fix": "Inline the function body into its call sites and remove the helper, unless you can rename it to encode important domain semantics."
        },
        {
          "id": "THIN_HELPER_SINGLE_CALL",
          "entity_type": "function",
          "severity": "warning",
          "description": "Trivial helper used only once.",
          "condition": {
            "all": [
              { "metric": "func_lines", "op": "<=", "value_from": "thresholds.function.min_helper_length" },
              { "metric": "call_count", "op": "==", "value": 1 },
              { "metric": "name_semantic_score", "op": "<", "value_from": "thresholds.semantic.meaningful_name_threshold" }
            ]
          },
          "score_impact": -0.15,
          "message": "Thin helper is called only once; this indirection likely hurts clarity.",
          "suggested_fix": "Inline this helper into its only call site."
        },
        {
          "id": "PASS_THROUGH_WRAPPER",
          "entity_type": "function",
          "severity": "warning",
          "description": "Detects pass-through wrappers that add indirection but no behavior.",
          "condition": {
            "all": [
              { "metric": "is_single_call_forwarder", "op": "==", "value": true },
              { "metric": "name_semantic_score", "op": "<", "value_from": "thresholds.semantic.meaningful_name_threshold" }
            ]
          },
          "score_impact": -0.2,
          "message": "Function is a pass-through wrapper that adds indirection without semantic value.",
          "suggested_fix": "Call the underlying function directly or make this wrapper add real transformation or domain semantics."
        },
        {
          "id": "FILE_THIN_HELPER_DENSITY",
          "entity_type": "file",
          "severity": "info",
          "description": "File has many thin helpers, suggesting excessive indirection.",
          "condition": {
            "any": [
              {
                "metric": "thin_helper_count",
                "op": ">",
                "value": 10
              }
            ]
          },
          "score_impact": -0.1,
          "message": "File contains many thin helpers; consider inlining or consolidating them.",
          "suggested_fix": "Review thin helpers and inline those that do not hide real complexity or domain concepts."
        }
      ]
    },
    {
      "id": "function_size_and_cohesion",
      "name": "Function Size & Cohesion",
      "weight": 0.25,
      "applies_to": ["function"],
      "checks": [
        {
          "id": "SOFT_TOO_LONG_FUNCTION",
          "entity_type": "function",
          "severity": "info",
          "description": "Function exceeds the soft recommended maximum length.",
          "condition": {
            "metric": "func_lines",
            "op": ">",
            "value_from": "thresholds.function.max_function_length_soft"
          },
          "score_impact": -0.1,
          "message": "Function is longer than the soft maximum; check if it mixes multiple responsibilities.",
          "suggested_fix": "Look for logical substeps and consider extracting them into well-named helpers if it improves clarity."
        },
        {
          "id": "HARD_TOO_LONG_FUNCTION",
          "entity_type": "function",
          "severity": "warning",
          "description": "Function exceeds the hard maximum length.",
          "condition": {
            "metric": "func_lines",
            "op": ">",
            "value_from": "thresholds.function.max_function_length_hard"
          },
          "score_impact": -0.3,
          "message": "Function is likely a \"mega-function\" and hard to understand as one idea.",
          "suggested_fix": "Refactor into multiple functions, each capturing a single coherent phase (e.g., parse/validate/execute)."
        },
        {
          "id": "LOW_COHESION_FUNCTION",
          "entity_type": "function",
          "severity": "warning",
          "description": "Function likely mixes unrelated domains or responsibilities.",
          "condition": {
            "metric": "local_domain_spread",
            "op": ">",
            "value_from": "thresholds.function.max_local_domain_spread"
          },
          "score_impact": -0.25,
          "message": "Function touches many unrelated concerns and is probably low cohesion.",
          "suggested_fix": "Split the function so each new function deals with one concept or domain."
        }
      ]
    },
    {
      "id": "indirection_and_call_depth",
      "name": "Indirection & Call Depth",
      "weight": 0.2,
      "applies_to": ["file", "project"],
      "checks": [
        {
          "id": "FILE_CALL_CHAIN_DEPTH",
          "entity_type": "file",
          "severity": "warning",
          "description": "Execution paths from entrypoints in this file are too deep.",
          "condition": {
            "metric": "max_call_chain_depth",
            "op": ">",
            "value_from": "thresholds.file.max_call_chain_depth"
          },
          "score_impact": -0.2,
          "message": "Call chains are deep; this makes it hard to reason about behavior end-to-end.",
          "suggested_fix": "Flatten the call graph by removing pass-through wrappers and merging trivial layers."
        },
        {
          "id": "PROJECT_CALL_CHAIN_DEPTH",
          "entity_type": "project",
          "severity": "warning",
          "description": "Overall project has very deep call chains from public entrypoints.",
          "condition": {
            "metric": "max_project_call_chain_depth",
            "op": ">",
            "value_from": "thresholds.project.max_project_call_chain_depth"
          },
          "score_impact": -0.25,
          "message": "Project call graph has very deep chains, which increases cognitive load and coupling.",
          "suggested_fix": "Identify deepest chains and refactor to reduce hop count, especially where intermediate functions add no semantic value."
        }
      ]
    },
    {
      "id": "duplication_vs_dry",
      "name": "Duplication vs DRY",
      "weight": 0.15,
      "applies_to": ["project"],
      "checks": [
        {
          "id": "HARMFUL_DUPLICATION",
          "entity_type": "project",
          "severity": "warning",
          "description": "Non-trivial duplicated blocks appear in many places.",
          "condition": {
            "all": [
              { "metric": "duplicate_block_count", "op": ">", "value": 0 }
            ]
          },
          "score_impact": -0.2,
          "message": "Project has repeated complex logic that likely deserves shared helpers.",
          "suggested_fix": "Inspect duplicate_block_details; where the same complex logic appears 3+ times, extract a well-named helper or module."
        }
      ]
    },
    {
      "id": "comments_and_explanation",
      "name": "Comments & Explanation",
      "weight": 0.15,
      "applies_to": ["function"],
      "checks": [
        {
          "id": "OVERCOMMENTED_FUNCTION",
          "entity_type": "function",
          "severity": "info",
          "description": "Function has very high comment density.",
          "condition": {
            "metric": "comment_density",
            "op": ">",
            "value_from": "thresholds.function.max_comment_density"
          },
          "score_impact": -0.05,
          "message": "Function may be overcommented, potentially obscuring the logic.",
          "suggested_fix": "Remove comments that simply restate what obvious code does; keep only \"why\" and non-obvious explanations."
        },
        {
          "id": "UNDEREXPLAINED_COMPLEX_FUNCTION",
          "entity_type": "function",
          "severity": "warning",
          "description": "Complex functions lack any high-level explanation.",
          "condition": {
            "all": [
              { "metric": "func_lines", "op": ">", "value_from": "thresholds.function.max_function_length_soft" },
              { "metric": "nesting_depth", "op": ">=", "value": 3 },
              { "metric": "comment_density", "op": "<", "value_from": "thresholds.function.min_comment_density_for_complex" }
            ]
          },
          "score_impact": -0.2,
          "message": "Complex function is under-documented; readers may struggle to understand intent.",
          "suggested_fix": "Add a short docstring or leading comment summarizing the purpose, invariants, and any non-obvious design decisions."
        }
      ]
    }
  ],

  "scoring_model": {
    "aggregation": "weighted_sum",
    "scale": {
      "min": 0,
      "max": 1
    },
    "default_start_score": 1.0,
    "dimension_weights_normalize": true,
    "verdicts": [
      {
        "id": "ACCEPT",
        "min_score": 0.8,
        "label": "Accept",
        "description": "Code meets clarity standards; only minor issues or informational notes."
      },
      {
        "id": "REFINE",
        "min_score": 0.6,
        "max_score": 0.79,
        "label": "Refine",
        "description": "Code is mostly clear but has notable clarity issues; refactors recommended."
      },
      {
        "id": "REJECT",
        "max_score": 0.59,
        "label": "Reject",
        "description": "Clarity problems are significant; code should be refactored before merge."
      }
    ]
  }
}
